# KPT Enabled OpenStack Barbican Key Management System
This software is a research proof of concept and not tested for production use
This project is tested with Ubuntu version 16.04. Please make sure to have Intel(R) KPT installed and tested before proceeding.

## Barbican Server Installation
### Installing system dependencies
```
  # Install development tools
  sudo apt-get install git python-tox

  # Install dependency build requirements
  sudo apt-get install libffi-dev libssl-dev python-dev gcc
 
  # Install new dependency 
  sudo apt-get install cryptography pyasn1 Crypto

```

### Setting up a virtual environment
```
  cd Barbican\barbican-kpt-server

  # Create and activate a virtual environment
  virtualenv .barbicanenv
  . .barbicanenv/bin/activate

  # Install barbican in development mode
  pip install -e $PWD

```

### Change the IP of host in bin\barbican-api
```
  httpserver.serve(application, host='{IP of host}', port='9311')
```

### Configuring Barbican
Barbican uses oslo.config for configuration. By default the api process will look for the configuration file in $HOME/barbican.conf or /etc/barbican/barbican.conf. The sample configuration files included in the source code assume that you’ll be using /etc/barbican/ for configuration and /var/lib/barbican for the database file location.
```
  # Create the directories and copy the config files
  sudo mkdir /etc/barbican
  sudo mkdir /var/lib/barbican
  sudo chown $(whoami) /etc/barbican
  sudo chown $(whoami) /var/lib/barbican
  cp -r etc/barbican /etc
```

## Barbican-KPT Running
If you made it this far you should be able to run the barbican development server using this command:
```
  bin/barbican-api
```
Now you can save and get secrets with kpt in the Barbican.
We introduce a flag in “Name” field like “encrypted_secret” to indicate a encrypted secrete and encrypted KEK will be generated by barbican.
### Example
Step1. Secret registration
```
  curl -vv -H "X-Project-Id: 12345" \
  -H 'Accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{"name": “encrypted_secret",
  "secret_type": "private",
  "algorithm": "RSA"}' \
  http://10.67.118.192:9311/v1/secrets | python -m json.tool 
```
Return reference to 
```
  Secret : xxxx-xxxx-xxxxx
  Individual public key:  yyyy-yyyy-yyyy
  Encrypted blob (Secret + KEK): zzzz-zzzz-zzzz
```
Step2. Provision client secret
```
  curl -vv -X PUT -H "X-Project-Id: 12345" \
  -H 'Accept: application/json' \
  -H 'Content-Type: application/octet-stream' \
  --data-binary @server.key \
  http://10.67.118.192:9311/v1/secrets/ xxxx-xxxx-xxxxx
```
Step3. Provision client public
```
  curl -vv -X PUT -H "X-Project-Id: 12345" \
  -H 'Accept: application/json' \
  -H 'Content-Type: application/octet-stream' \
  --data-binary @ipub.key \
  http://10.67.118.192:9311/v1/secrets/ yyyy-yyyy-yyyy
```
Step4. Retrieve encrypted blob
```
  curl -vv -H "X-Project-Id: 12345" \
  -H 'Accept: application/octet-stream ' \
  -o retrieved_blob \
  http://10.67.118.192:9311/v1/secrets/ zzzz-zzzz-zzzz
```
